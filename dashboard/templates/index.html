<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Sports Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 1400px;
        }
        .metric-card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }
        .profit {
            color: #10b981;
        }
        .loss {
            color: #ef4444;
        }
        .chart-container, .card, .table-container {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .message-box.success { background-color: #10b981; }
        .message-box.error { background-color: #ef4444; }
        .message-box.visible { opacity: 1; }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .win-char { color: #10b981; font-weight: bold; }
        .loss-char { color: #ef4444; font-weight: bold; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #2563eb;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-start min-h-screen p-8">
    
    <div id="message-box" class="message-box"></div>
    <div id="loading-spinner" class="spinner hidden"></div>

    <div class="container mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-5xl font-extrabold text-gray-800">Sports Betting Dashboard</h1>
            <p class="text-xl text-gray-500 mt-2">Professional Analytics & Bot Management</p>
            <p class="text-sm text-gray-400 mt-2">User ID: <span id="user-id">Loading...</span></p>
        </header>

        <section id="overall-stats-section" class="mb-12">
            <h2 class="text-2xl font-bold mb-4">Overall Stats</h2>
            <div id="stats-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="metric-card">
                    <div class="flex items-center space-x-4">
                        <span class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14v4m-4 0h8a2 2 0 002-2v-4a2 2 0 00-2-2h-8a2 2 0 00-2 2v4a2 2 0 002 2z" />
                            </svg>
                        </span>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Profit/Loss</p>
                            <p id="total-profit" class="text-3xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="flex items-center space-x-4">
                        <span class="p-3 rounded-full bg-green-100 text-green-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13c0 1.105-.895 2-2 2h-4a2 2 0 01-2-2z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </span>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Wagers</p>
                            <p id="total-wagers" class="text-3xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="flex items-center space-x-4">
                        <span class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                            </svg>
                        </span>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Win Rate</p>
                            <p id="win-rate" class="text-3xl font-bold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="flex items-center space-x-4">
                        <span class="p-3 rounded-full bg-purple-100 text-purple-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.484 9.231 5.02 7.828 5.467 6.425 5.914 5.345 6.953 4.933 8.322c-.412 1.37-.23 2.825.43 4.143l1.832 3.663a9.08 9.08 0 005.65 2.768m0-13c1.168 0 2.167.464 2.828 1.125.66.66 1.125 1.66 1.125 2.828v2.75l-1.832 3.663c-.66 1.318-.842 2.773-.43 4.143l.43 1.442M12 6.253v13" />
                            </svg>
                        </span>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Best Bot</p>
                            <p id="best-bot-name" class="text-lg font-bold text-gray-900">-</p>
                            <p id="best-bot-profit" class="text-sm font-medium text-gray-600">-</p>
                        </div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="flex items-center space-x-4">
                        <span class="p-3 rounded-full bg-red-100 text-red-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </span>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Worst Bot</p>
                            <p id="worst-bot-name" class="text-lg font-bold text-gray-900">-</p>
                            <p id="worst-bot-profit" class="text-sm font-medium text-gray-600">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="table-container mb-12">
            <h2 class="text-2xl font-bold mb-4">Active Bots</h2>
            <div id="active-bots-container" class="overflow-x-auto rounded-lg shadow-sm">
                <p id="active-bots-loading" class="text-center text-gray-500">Loading active bots...</p>
            </div>
        </section>

        <section class="table-container mb-12">
            <h2 class="text-2xl font-bold mb-4">Bot Manager</h2>
            
            <form id="add-bot-form" class="flex flex-col md:flex-row gap-4 mb-6">
                <input type="text" name="name" placeholder="Bot Name" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input type="number" name="starting_balance" placeholder="Starting Balance" step="0.01" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input type="number" name="bet_percentage" placeholder="Bet %" step="0.01" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input type="number" name="max_bets_per_week" placeholder="Max Bets / Week" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <select id="strategy-select" name="strategy_id" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select Strategy</option>
                </select>
                <select name="sport" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select Sport</option>
                    <option value="NBA">NBA</option>
                    <option value="NFL">NFL</option>
                    <option value="MLB">MLB</option>
                    <option value="NCAAF">NCAAF</option>
                    <option value="NCAAB">NCAAB</option>
                </select>
                <select name="bet_type" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select Bet Type</option>
                    <option value="Moneyline">Moneyline</option>
                    <option value="Spread">Spread</option>
                    <option value="Total">Total</option>
                </select>
                <button type="submit" class="p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-300">Add Bot</button>
            </form>

            <div id="inactive-bots-container" class="overflow-x-auto rounded-lg shadow-sm">
                <p id="inactive-bots-loading" class="text-center text-gray-500">Loading inactive bots...</p>
            </div>
        </section>

        <section class="table-container">
            <h2 class="text-2xl font-bold mb-4">Strategy Editor</h2>
            
            <form id="add-strategy-form" class="flex flex-col md:flex-row gap-4 mb-6">
                <input type="text" name="name" placeholder="Strategy Name" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                <select name="type" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                    <option value="">Select Type</option>
                    <option value="normal">Normal</option>
                    <option value="recovery">Recovery</option>
                </select>
                <select id="linked-strategy-select" name="linked_strategy_id" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="">Link Recovery Strategy (Optional)</option>
                </select>
                <button type="submit" class="p-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition duration-300">Add Strategy</button>
            </form>
            
            <div id="strategies-container" class="overflow-x-auto rounded-lg shadow-sm">
                <p id="strategies-loading" class="text-center text-gray-500">Loading strategies...</p>
            </div>
        </section>
    </div>
    
    <div id="bot-details-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="window.closeModal('bot-details-modal')">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Edit Bot: <span id="modal-bot-name"></span></h2>
            <form id="edit-bot-form" class="space-y-4">
                <input type="hidden" id="modal-bot-id">
                <div>
                    <label for="modal-name" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="modal-name" name="name" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="modal-strategy" class="block text-sm font-medium text-gray-700">Strategy</label>
                    <select id="modal-strategy" name="strategy_id" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </select>
                </div>
                <div>
                    <label for="modal-balance" class="block text-sm font-medium text-gray-700">Current Balance</label>
                    <input type="number" step="0.01" id="modal-balance" name="current_balance" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" disabled>
                </div>
                <div>
                    <label for="modal-bet-percent" class="block text-sm font-medium text-gray-700">Bet % of Balance</label>
                    <input type="number" step="0.01" id="modal-bet-percent" name="bet_percentage" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="modal-max-bets" class="block text-sm font-medium text-gray-700">Max Bets / Week</label>
                    <input type="number" id="modal-max-bets" name="max_bets_per_week" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-300">Save Changes</button>
            </form>
        </div>
    </div>
    
    <div id="strategy-details-modal" class="modal">
        <div class="modal-content max-w-2xl">
            <span class="modal-close" onclick="window.closeModal('strategy-details-modal')">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Edit Strategy: <span id="strategy-modal-name"></span></h2>
            <form id="edit-strategy-form" class="space-y-4">
                <input type="hidden" id="strategy-modal-id">
                <div>
                    <label for="strategy-modal-description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="strategy-modal-description" name="description" rows="4" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Parameters</label>
                    <div id="strategy-modal-parameters" class="mt-1 space-y-3">
                        </div>
                </div>
                <button type="submit" class="w-full p-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition duration-300">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="history-modal" class="modal">
        <div class="modal-content max-w-2xl">
            <span class="modal-close" onclick="window.closeModal('history-modal')">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Bet History for <span id="history-bot-name"></span></h2>
            <div class="overflow-y-auto max-h-96">
                <table class="w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teams</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Wager</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Odds</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payout</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Outcome</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="bot-log-modal" class="modal">
        <div class="modal-content max-w-2xl">
            <span class="modal-close" onclick="window.closeModal('bot-log-modal')">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Bot Log for <span id="log-bot-name"></span></h2>
            <div class="overflow-y-auto max-h-96 bg-gray-100 p-4 rounded-md text-sm font-mono whitespace-pre-wrap">
                <pre id="bot-log-content"></pre>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, getDocs, setDoc, getDoc, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable debug logging for Firestore
        setLogLevel('Debug');

        // --- GLOBAL VARIABLES & INITIALIZATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : '1:945213178297:web:40f6e200fd00148754b668';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firestore data collections
        let db, auth;
        let userId = 'anonymous';
        let bots = [];
        let strategies = [];
        
        // UI elements
        const activeBotsContainer = document.getElementById('active-bots-container');
        const inactiveBotsContainer = document.getElementById('inactive-bots-container');
        const strategiesContainer = document.getElementById('strategies-container');
        const strategySelect = document.getElementById('strategy-select');
        const linkedStrategySelect = document.getElementById('linked-strategy-select');
        const botDetailsModal = document.getElementById('bot-details-modal');
        const strategyDetailsModal = document.getElementById('strategy-details-modal');
        const historyModal = document.getElementById('history-modal');
        const botLogModal = document.getElementById('bot-log-modal');

        // --- FIREBASE SETUP & AUTHENTICATION ---
        window.onload = async function() {
            try {
                const firebaseConfig = {
                apiKey: "AIzaSyCmtCJTzQN81oN_2sHKEq8P2ededP5y8gY",
                authDomain: "si-hq-7a4d5.firebaseapp.com",
                projectId: "si-hq-7a4d5",
                storageBucket: "si-hq-7a4d5.firebasestorage.app",
                messagingSenderId: "945213178297",
                appId: "1:945213178297:web:40f6e200fd00148754b668"
                };

                if (!firebaseConfig.projectId || firebaseConfig.projectId === "None") {
                    console.warn("Firebase initialization skipped: 'projectId' not provided in the configuration.");
                    showMessage('App is running in demo mode. No database connection.', 'error');
                    return;
                }

                const app = initializeApp(firebaseConfig); 
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;
                        setupFirestoreListeners();
                        fetchOverallStats();
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                showMessage('Failed to initialize the app. Check the console.', 'error');
            }
        };

        // --- FIREBASE LISTENERS ---
        function setupFirestoreListeners() {
            const strategiesRef = collection(db, `artifacts/${appId}/users/${userId}/strategies`);
            onSnapshot(strategiesRef, (snapshot) => {
                strategies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStrategies();
                renderBotForms();
                console.log("Strategies updated:", strategies);
            }, (error) => {
                console.error("Error fetching strategies:", error);
                showMessage("Failed to load strategies.", 'error');
            });

            const botsRef = collection(db, `artifacts/${appId}/users/${userId}/bots`);
            onSnapshot(botsRef, (snapshot) => {
                bots = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBots();
                fetchOverallStats(); // Refresh overall stats on bot data change
                console.log("Bots updated:", bots);
            }, (error) => {
                console.error("Error fetching bots:", error);
                showMessage("Failed to load bots.", 'error');
            });
        }

        // --- OVERALL STATS FETCH ---
        async function fetchOverallStats() {
            showLoading();
            try {
                const response = await fetch('/api/overall-stats');
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.stats;
                    
                    const totalProfitElement = document.getElementById('total-profit');
                    totalProfitElement.textContent = `$${stats.total_profit.toFixed(2)}`;
                    if (stats.total_profit >= 0) {
                        totalProfitElement.classList.add('profit');
                        totalProfitElement.classList.remove('loss');
                    } else {
                        totalProfitElement.classList.add('loss');
                        totalProfitElement.classList.remove('profit');
                    }

                    document.getElementById('total-wagers').textContent = `$${stats.total_wagered.toFixed(2)}`;
                    document.getElementById('win-rate').textContent = `${stats.win_rate.toFixed(2)}%`;
                    
                    document.getElementById('best-bot-name').textContent = stats.best_bot.name;
                    const bestBotProfitElement = document.getElementById('best-bot-profit');
                    bestBotProfitElement.textContent = `P/L: $${stats.best_bot.profit_loss.toFixed(2)}`;
                    if (stats.best_bot.profit_loss >= 0) {
                        bestBotProfitElement.classList.add('profit');
                        bestBotProfitElement.classList.remove('loss');
                    } else {
                        bestBotProfitElement.classList.add('loss');
                        bestBotProfitElement.classList.remove('profit');
                    }
                    
                    document.getElementById('worst-bot-name').textContent = stats.worst_bot.name;
                    const worstBotProfitElement = document.getElementById('worst-bot-profit');
                    worstBotProfitElement.textContent = `P/L: $${stats.worst_bot.profit_loss.toFixed(2)}`;
                    if (stats.worst_bot.profit_loss >= 0) {
                        worstBotProfitElement.classList.add('profit');
                        worstBotProfitElement.classList.remove('loss');
                    } else {
                        worstBotProfitElement.classList.add('loss');
                        worstBotProfitElement.classList.remove('profit');
                    }
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error("Failed to fetch overall stats:", error);
                showMessage('Failed to fetch overall stats.', 'error');
            } finally {
                hideLoading();
            }
        }

        // --- RENDERING FUNCTIONS ---
        function renderStrategies() {
            const container = document.getElementById('strategies-container');
            if (strategies.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 mt-4">No strategies found. Add a new one to get started!</p>`;
                return;
            }

            const tableHtml = `
                <div class="overflow-x-auto rounded-lg shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recovery Strategy</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${strategies.map(s => {
                                const linkedStrategy = strategies.find(ls => ls.id === s.linked_strategy_id);
                                return `
                                    <tr id="strategy-row-${s.id}" class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap">${s.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.type}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${linkedStrategy ? linkedStrategy.name : 'None'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${s.description || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <button onclick="window.showStrategyDetails('${s.id}')" class="text-indigo-600 hover:text-indigo-900 transition duration-300 mr-2">View Details</button>
                                            <button onclick="window.deleteStrategy('${s.id}')" class="text-red-600 hover:text-red-900 transition duration-300">Delete</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHtml;
        }

        function renderBotForms() {
            const normalStrategies = strategies.filter(s => s.type === 'normal');
            const recoveryStrategies = strategies.filter(s => s.type === 'recovery');
            
            // Clear and populate strategy select for add bot form
            strategySelect.innerHTML = '<option value="">Select Strategy</option>';
            normalStrategies.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.name;
                strategySelect.appendChild(option);
            });

            // Clear and populate linked strategy select for add strategy form
            linkedStrategySelect.innerHTML = '<option value="">Link Recovery Strategy (Optional)</option>';
            recoveryStrategies.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.name;
                linkedStrategySelect.appendChild(option);
            });
        }

        function renderBots() {
            const activeBots = bots.filter(b => b.status === 'Active');
            const inactiveBots = bots.filter(b => b.status !== 'Active');
            
            let activeBotsHtml = `<p class="text-center text-gray-500 mt-4">No bots are currently active.</p>`;
            if (activeBots.length > 0) {
                activeBotsHtml = `
                <div class="overflow-x-auto rounded-lg shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strategy</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sport</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max Bets / Week</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">W/L</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last 10</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recovery Strategy</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${activeBots.map(b => {
                                const strategy = strategies.find(s => s.id === b.strategy_id);
                                const recoveryStrategy = strategies.find(s => s.id === (strategy ? strategy.linked_strategy_id : null));
                                const last10 = (b.bet_history || []).slice(-10).map(bet => {
                                    const outcomeClass = bet.outcome === 'W' ? 'win-char' : 'loss-char';
                                    return `<span class="${outcomeClass}">${bet.outcome}</span>`;
                                }).join('');

                                const recoveryButtonText = b.is_recovery_active ? 'Deactivate Recovery' : 'Activate Recovery';
                                const recoveryButtonColor = b.is_recovery_active ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600';
                                const recoveryButtonDisabled = !recoveryStrategy;
                                const recoveryButtonClasses = `p-2 text-white font-semibold rounded-lg transition duration-300 text-xs ${recoveryButtonColor} ${recoveryButtonDisabled ? 'opacity-50 cursor-not-allowed' : ''}`;

                                return `
                                    <tr id="bot-row-${b.id}" class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap">${b.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${strategy ? strategy.name : 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${b.sport || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${b.bet_type || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${b.current_balance.toFixed(2)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${b.max_bets_per_week || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${b.career_wins || 0}/${b.career_losses || 0}</td>
                                        <td class="px-6 py-4 whitespace-nowrap font-mono">${last10}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <button onclick="window.toggleRecoveryStrategy('${b.id}')" class="${recoveryButtonClasses}" ${recoveryButtonDisabled ? 'disabled' : ''}>${recoveryButtonText}</button>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">${b.status}</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4 flex items-center justify-end">
                                            <button onclick="window.toggleBotStatus('${b.id}')" class="text-red-600 hover:text-red-900 transition duration-300">Deactivate</button>
                                            <button onclick="window.showHistoryModal('${b.id}')" class="p-2 bg-gray-200 text-gray-800 text-xs font-semibold rounded-lg hover:bg-gray-300 transition duration-300">View History</button>
                                            <button onclick="window.showLogModal('${b.id}')" class="p-2 bg-gray-200 text-gray-800 text-xs font-semibold rounded-lg hover:bg-gray-300 transition duration-300">View Log</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                `;
            }
            activeBotsContainer.innerHTML = activeBotsHtml;

            let inactiveBotsHtml = `<p class="text-center text-gray-500 mt-4">No inactive bots found. Add a new bot to get started!</p>`;
            if (inactiveBots.length > 0) {
                inactiveBotsHtml = `
                <div class="overflow-x-auto rounded-lg shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strategy</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sport</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max Bets / Week</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">W/L</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last 10</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recovery Strategy</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${inactiveBots.map(b => {
                                const strategy = strategies.find(s => s.id === b.strategy_id);
                                const recoveryStrategy = strategies.find(s => s.id === (strategy ? strategy.linked_strategy_id : null));
                                const last10 = (b.bet_history || []).slice(-10).map(bet => {
                                    const outcomeClass = bet.outcome === 'W' ? 'win-char' : 'loss-char';
                                    return `<span class="${outcomeClass}">${bet.outcome}</span>`;
                                }).join('');

                                const recoveryButtonText = b.is_recovery_active ? 'Deactivate Recovery' : 'Activate Recovery';
                                const recoveryButtonColor = b.is_recovery_active ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600';
                                const recoveryButtonDisabled = !recoveryStrategy;
                                const recoveryButtonClasses = `p-2 text-white font-semibold rounded-lg transition duration-300 text-xs ${recoveryButtonColor} ${recoveryButtonDisabled ? 'opacity-50 cursor-not-allowed' : ''}`;

                                return `
                                    <tr id="bot-row-${b.id}" class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap">${b.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${strategy ? strategy.name : 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${b.sport || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${b.bet_type || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${b.current_balance.toFixed(2)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${b.max_bets_per_week || 'N/A'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">${b.career_wins || 0}/${b.career_losses || 0}</td>
                                        <td class="px-6 py-4 whitespace-nowrap font-mono">${last10}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <button onclick="window.toggleRecoveryStrategy('${b.id}')" class="${recoveryButtonClasses}" ${recoveryButtonDisabled ? 'disabled' : ''}>${recoveryButtonText}</button>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">${b.status}</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                                            <button onclick="window.toggleBotStatus('${b.id}')" class="text-green-600 hover:text-green-900 transition duration-300">Activate</button>
                                            <button onclick="window.deleteBot('${b.id}')" class="text-red-600 hover:text-red-900 transition duration-300">Delete</button>
                                            <button onclick="window.showHistoryModal('${b.id}')" class="p-2 bg-gray-200 text-gray-800 text-xs font-semibold rounded-lg hover:bg-gray-300 transition duration-300">View History</button>
                                            <button onclick="window.showLogModal('${b.id}')" class="p-2 bg-gray-200 text-gray-800 text-xs font-semibold rounded-lg hover:bg-gray-300 transition duration-300">View Log</button>
                                            <button onclick="window.showBotDetails('${b.id}')" class="p-2 bg-gray-200 text-gray-800 text-xs font-semibold rounded-lg hover:bg-gray-300 transition duration-300">View Details</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                `;
            }
            inactiveBotsContainer.innerHTML = inactiveBotsHtml;
        }

        // --- UI FUNCTIONS ---
        // Expose functions to the global scope
        window.showMessage = function(message, type) {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.className = `message-box visible ${type}`;
            setTimeout(() => {
                msgBox.className = `message-box ${type}`;
            }, 3000);
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showLoading() {
            document.getElementById('loading-spinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-spinner').classList.add('hidden');
        }
        
        window.showBotDetails = function(botId) {
            const bot = bots.find(b => b.id === botId);
            if (!bot) {
                console.error('Bot not found for ID:', botId);
                showMessage('Could not find bot details.', 'error');
                return;
            }

            try {
                document.getElementById('modal-bot-id').value = bot.id;
                document.getElementById('modal-bot-name').textContent = bot.name;
                document.getElementById('modal-name').value = bot.name;
                document.getElementById('modal-balance').value = bot.current_balance.toFixed(2);
                document.getElementById('modal-bet-percent').value = bot.bet_percentage;
                document.getElementById('modal-max-bets').value = bot.max_bets_per_week || '';
                
                const modalStrategySelect = document.getElementById('modal-strategy');
                modalStrategySelect.innerHTML = '';
                strategies.forEach(strategy => {
                    const option = document.createElement('option');
                    option.value = strategy.id;
                    option.textContent = strategy.name;
                    if (strategy.id === bot.strategy_id) {
                        option.selected = true;
                    }
                    modalStrategySelect.appendChild(option);
                });

                botDetailsModal.style.display = 'flex';
            } catch (error) {
                console.error('Error in showBotDetails:', error);
                showMessage('An error occurred while opening the edit modal.', 'error');
            }
        }

        window.showStrategyDetails = function(strategyId) {
            const strategy = strategies.find(s => s.id === strategyId);
            if (!strategy) {
                console.error('Strategy not found for ID:', strategyId);
                showMessage('Could not find strategy details.', 'error');
                return;
            }

            try {
                document.getElementById('strategy-modal-id').value = strategy.id;
                document.getElementById('strategy-modal-name').textContent = strategy.name;
                document.getElementById('strategy-modal-description').value = strategy.description || '';

                const parametersContainer = document.getElementById('strategy-modal-parameters');
                parametersContainer.innerHTML = '';

                if (strategy.parameters) {
                    for (const key in strategy.parameters) {
                        const param = strategy.parameters[key];
                        const div = document.createElement('div');
                        div.className = 'flex flex-col';
                        
                        const label = document.createElement('label');
                        label.className = 'text-sm font-medium text-gray-700 capitalize';
                        label.textContent = key.replace(/_/g, ' ');

                        const input = document.createElement('input');
                        input.type = param.type;
                        input.name = key;
                        input.value = param.value;
                        input.step = param.type === 'number' ? 'any' : null;
                        input.className = 'mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500';
                        
                        div.appendChild(label);
                        div.appendChild(input);
                        parametersContainer.appendChild(div);
                    }
                } else {
                    parametersContainer.innerHTML = '<p class="text-gray-500">No configurable parameters for this strategy.</p>';
                }

                strategyDetailsModal.style.display = 'flex';
            } catch (error) {
                console.error('Error in showStrategyDetails:', error);
                showMessage('An error occurred while opening the strategy details modal.', 'error');
            }
        }
        
        window.showHistoryModal = function(botId) {
            const bot = bots.find(b => b.id === botId);
            if (!bot) {
                console.error('Bot not found for ID:', botId);
                showMessage('Could not display history. Bot not found.', 'error');
                return;
            }
            
            try {
                document.getElementById('history-bot-name').textContent = bot.name;
                const historyBody = document.getElementById('history-table-body');
                historyBody.innerHTML = '';
                
                if (!bot.bet_history || bot.bet_history.length === 0) {
                    historyBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-4">No bet history available.</td></tr>';
                } else {
                    bot.bet_history.forEach((bet) => {
                        const row = document.createElement('tr');
                        const outcomeClass = bet.outcome === 'W' ? 'win' : 'loss';
                        const payoutValue = bet.payout.toFixed(2);
                        const payoutClass = bet.payout >= 0 ? 'profit' : 'loss';
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${bet.timestamp.toDate().toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${bet.teams}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${bet.wager.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${bet.odds}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="${payoutClass}">${payoutValue}</span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="${outcomeClass}">${bet.outcome}</span></td>
                        `;
                        historyBody.appendChild(row);
                    });
                }
                historyModal.style.display = 'flex';
            } catch (error) {
                console.error('Error in showHistoryModal:', error);
                showMessage('An error occurred while displaying history. Check console for details.', 'error');
            }
        }

        window.showLogModal = function(botId) {
            const bot = bots.find(b => b.id === botId);
            if (!bot) {
                showMessage('Could not find bot log.', 'error');
                return;
            }

            document.getElementById('log-bot-name').textContent = bot.name;
            const logContent = document.getElementById('bot-log-content');
            
            if (!bot.log_history || bot.log_history.length === 0) {
                logContent.textContent = 'No log entries found for this bot.';
            } else {
                logContent.textContent = bot.log_history
                    .map(entry => `[${entry.timestamp.toDate().toLocaleString()}] ${entry.message}`)
                    .join('\n');
            }
            botLogModal.style.display = 'flex';
        }

        // --- FIREBASE CRUD OPERATIONS ---
        async function logBotAction(botId, message) {
            try {
                const botRef = doc(db, `artifacts/${appId}/users/${userId}/bots`, botId);
                const logEntry = {
                    message: message,
                    timestamp: Timestamp.now()
                };
                await updateDoc(botRef, {
                    log_history: [
                        ...(bots.find(b => b.id === botId)?.log_history || []),
                        logEntry
                    ]
                });
            } catch (error) {
            }
        }

        window.addBot = async function(botData) {
            showLoading();
            try {
                const botRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/bots`), {
                    ...botData,
                    status: 'Inactive',
                    is_recovery_active: false,
                    career_wins: 0,
                    career_losses: 0,
                    current_win_streak: 0,
                    current_loss_streak: 0,
                    bet_history: [],
                    log_history: []
                });
                await logBotAction(botRef.id, `Bot initialized and created.`);
                showMessage('Bot added successfully!', 'success');
            } catch (error) {
                console.error("Error adding bot:", error);
                showMessage('Failed to add bot.', 'error');
            } finally {
                hideLoading();
            }
        }
        
        window.editBot = async function(botData) {
            showLoading();
            try {
                const botRef = doc(db, `artifacts/${appId}/users/${userId}/bots`, botData.id);
                await updateDoc(botRef, botData);
                showMessage('Bot updated successfully!', 'success');
            } catch (error) {
                console.error("Error updating bot:", error);
                showMessage('Failed to update bot.', 'error');
            } finally {
                hideLoading();
            }
        }

        window.editStrategy = async function(strategyId, newData) {
            showLoading();
            try {
                const strategyRef = doc(db, `artifacts/${appId}/users/${userId}/strategies`, strategyId);
                await updateDoc(strategyRef, newData);
                showMessage('Strategy updated successfully!', 'success');
            } catch (error) {
                console.error("Error updating strategy:", error);
                showMessage('Failed to update strategy.', 'error');
            } finally {
                hideLoading();
            }
        }

        window.deleteBot = async function(botId) {
            showLoading();
            try {
                const botRef = doc(db, `artifacts/${appId}/users/${userId}/bots`, botId);
                await deleteDoc(botRef);
                showMessage('Bot deleted successfully!', 'success');
            } catch (error) {
                console.error("Error deleting bot:", error);
                showMessage('Failed to delete bot.', 'error');
            } finally {
                hideLoading();
            }
        }

        window.addStrategy = async function(strategyData) {
            showLoading();
            try {
                const defaultParameters = {
                    min_odds: { value: 1.5, type: 'number' },
                    max_odds: { value: 3.0, type: 'number' },
                    bet_size_multiplier: { value: 1, type: 'number' },
                };
                const defaultDescription = `A standard betting strategy that places bets based on odds within a specified range. It can be configured with a bet size multiplier.`;

                const dataWithDefaults = {
                    ...strategyData,
                    description: defaultDescription,
                    parameters: defaultParameters,
                };
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/strategies`), dataWithDefaults);
                showMessage('Strategy added successfully!', 'success');
            } catch (error) {
                console.error("Error adding strategy:", error);
                showMessage('Failed to add strategy.', 'error');
            } finally {
                hideLoading();
            }
        }

        window.deleteStrategy = async function(strategyId) {
            showLoading();
            try {
                const strategyRef = doc(db, `artifacts/${appId}/users/${userId}/strategies`, strategyId);
                await deleteDoc(strategyRef);
                showMessage('Strategy deleted successfully!', 'success');
            } catch (error) {
                console.error("Error deleting strategy:", error);
                showMessage('Failed to delete strategy.', 'error');
            } finally {
                hideLoading();
            }
        }

        window.toggleBotStatus = async function(botId) {
            showLoading();
            try {
                const botRef = doc(db, `artifacts/${appId}/users/${userId}/bots`, botId);
                const botDoc = await getDoc(botRef);
                if (botDoc.exists()) {
                    const currentStatus = botDoc.data().status;
                    const newStatus = currentStatus === 'Active' ? 'Inactive' : 'Active';
                    await updateDoc(botRef, { status: newStatus });
                    await logBotAction(botId, `Bot status changed from ${currentStatus} to ${newStatus}.`);
                    showMessage(`Bot status changed to ${newStatus}!`, 'success');
                } else {
                    showMessage('Bot not found.', 'error');
                }
            } catch (error) {
                console.error("Error toggling bot status:", error);
                showMessage('Failed to toggle bot status.', 'error');
            } finally {
                hideLoading();
            }
        }
        
        window.toggleRecoveryStrategy = async function(botId) {
            showLoading();
            try {
                const botRef = doc(db, `artifacts/${appId}/users/${userId}/bots`, botId);
                const botDoc = await getDoc(botRef);
                if (botDoc.exists()) {
                    const currentBot = botDoc.data();
                    const newRecoveryState = !currentBot.is_recovery_active;
                    await updateDoc(botRef, { is_recovery_active: newRecoveryState });
                    await logBotAction(botId, `Recovery strategy ${newRecoveryState ? 'activated' : 'deactivated'}.`);
                    showMessage(`Recovery strategy ${newRecoveryState ? 'activated' : 'deactivated'}.`, 'success');
                } else {
                    showMessage('Bot not found.', 'error');
                }
            } catch (error) {
                console.error("Error toggling recovery strategy:", error);
                showMessage('Failed to toggle recovery strategy.', 'error');
            } finally {
                hideLoading();
            }
        }

        // --- FORM EVENT LISTENERS ---
        document.getElementById('add-bot-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const form = event.target;
            const botData = {
                name: form.name.value,
                starting_balance: parseFloat(form.starting_balance.value),
                current_balance: parseFloat(form.starting_balance.value),
                bet_percentage: parseFloat(form.bet_percentage.value),
                max_bets_per_week: parseInt(form.max_bets_per_week.value, 10),
                strategy_id: form.strategy_id.value,
                sport: form.sport.value,
                bet_type: form.bet_type.value,
            };
            await window.addBot(botData);
            form.reset();
        });

        document.getElementById('edit-bot-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const form = event.target;
            const botData = {
                id: form['modal-bot-id'].value,
                name: form['modal-name'].value,
                strategy_id: form['modal-strategy'].value,
                bet_percentage: parseFloat(form['modal-bet-percent'].value),
                max_bets_per_week: parseInt(form['modal-max-bets'].value, 10)
            };
            await window.editBot(botData);
            window.closeModal('bot-details-modal');
        });

        document.getElementById('add-strategy-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const form = event.target;
            const strategyData = {
                name: form.name.value,
                type: form.type.value,
                linked_strategy_id: form.linked_strategy_id.value || null
            };
            await window.addStrategy(strategyData);
            form.reset();
        });

        document.getElementById('edit-strategy-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const form = event.target;
            const strategyId = form['strategy-modal-id'].value;
            const newDescription = form['description'].value;
            const newParameters = {};
            const parameterInputs = document.getElementById('strategy-modal-parameters').querySelectorAll('input');

            parameterInputs.forEach(input => {
                const key = input.name;
                const type = input.type;
                let value = input.value;

                if (type === 'number') {
                    value = parseFloat(value);
                }

                newParameters[key] = {
                    value,
                    type,
                };
            });

            await window.editStrategy(strategyId, {
                description: newDescription,
                parameters: newParameters
            });
            window.closeModal('strategy-details-modal');
        });
    </script>
</body>
</html>